const express = require("express"); const twilio = require("twilio"); const axios = require("axios"); const { Client } = require("@notionhq/client"); const app = express(); const PORT = process.env.PORT || 3000; const accountSid = process.env.TWILIO_ACCOUNT_SID; const authToken = process.env.TWILIO_AUTH_TOKEN; const client = twilio(accountSid, authToken); const notion = new Client({ auth: process.env.NOTION_API_KEY }); const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY; app.use(express.json()); app.use(express.urlencoded({ extended: true })); app.get("/health", (req, res) => { res.json({ status: "healthy", service: "LUMA Fixed Server", timestamp: new Date().toISOString(), port: PORT, env: { twilio_sid: accountSid ? "SET" : "MISSING", notion_key: process.env.NOTION_API_KEY ? "SET" : "MISSING", openrouter_key: OPENROUTER_API_KEY ? "SET" : "MISSING" } }); }); app.get("/", (req, res) => { res.send("🔥 LUMA FIXED SERVER - OPÉRATIONNEL !"); }); app.post("/webhook/twilio-whatsapp", async (req, res) => { try { console.log("🔍 DEBUG: Webhook reçu"); console.log("🔍 DEBUG: Body:", JSON.stringify(req.body, null, 2)); const { Body, From, To } = req.body; console.log(`📱 Message reçu de ${From}: ${Body}`); console.log("🔍 DEBUG: Test OpenRouter..."); const aiResponse = await generateAIResponse(Body); console.log("🔍 DEBUG: Réponse IA:", aiResponse); console.log("🔍 DEBUG: Test Twilio..."); const twilioResult = await client.messages.create({ body: aiResponse, from: `whatsapp:${process.env.WHATSAPP_NUMBER}`, to: From }); console.log("🔍 DEBUG: Twilio result:", twilioResult.sid); console.log("🔍 DEBUG: Test Notion..."); await logToNotion(From, Body, aiResponse); console.log("✅ DEBUG: Tout fonctionne !"); res.status(200).send("OK"); } catch (error) { console.error("❌ DEBUG ERREUR:", error.message); console.error("❌ DEBUG STACK:", error.stack); res.status(500).send("Erreur: " + error.message); } }); async function generateAIResponse(message) { try { console.log("🔍 DEBUG: Appel OpenRouter..."); console.log("🔍 DEBUG: API Key:", OPENROUTER_API_KEY ? "PRESENT" : "MISSING"); const response = await axios.post("https://openrouter.ai/api/v1/chat/completions", { model: "anthropic/claude-3.5-sonnet", messages: [{ role: "system", content: "Tu es LUMA, un assistant IA professionnel et bienveillant. Réponds de manière claire, utile et en français." }, { role: "user", content: message }] }, { headers: { "Authorization": `Bearer ${OPENROUTER_API_KEY}`, "Content-Type": "application/json", "HTTP-Referer": "https://web-production-6d34.up.railway.app", "X-Title": "LUMA WhatsApp Bot" } }); console.log("🔍 DEBUG: OpenRouter response:", response.data); return response.data.choices[0].message.content; } catch (error) { console.error("❌ DEBUG Erreur OpenRouter:", error.response?.data || error.message); console.error("❌ DEBUG Status:", error.response?.status); console.error("❌ DEBUG Headers:", error.response?.headers); return "Désolé, je ne peux pas répondre pour le moment."; } } async function logToNotion(from, message, response) { try { console.log("🔍 DEBUG: Log Notion..."); await notion.pages.create({ parent: { database_id: process.env.WHATSAPP_HUB_DB }, properties: { "From": { title: [{ text: { content: from } }] }, "Message": { rich_text: [{ text: { content: message } }] }, "Response": { rich_text: [{ text: { content: response } }] }, "Date": { date: { start: new Date().toISOString() } } } }); console.log("✅ DEBUG: Notion loggé"); } catch (error) { console.error("❌ DEBUG Erreur Notion:", error.message); } } app.listen(PORT, "0.0.0.0", () => { console.log("🚀 LUMA Fixed Server démarré"); console.log(`🌐 Port: ${PORT}`); console.log("✅ Health check: /health"); console.log("📡 Webhook: /webhook/twilio-whatsapp"); console.log("🔧 CORRECTIONS APPLIQUÉES"); });
