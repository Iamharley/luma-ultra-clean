const express = require("express"); const twilio = require("twilio"); const axios = require("axios"); const { Client } = require("@notionhq/client"); const app = express(); const PORT = process.env.PORT || 3000; const accountSid = process.env.TWILIO_ACCOUNT_SID; const authToken = process.env.TWILIO_AUTH_TOKEN; const client = twilio(accountSid, authToken); const notion = new Client({ auth: process.env.NOTION_API_KEY }); const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY; app.use(express.json()); app.use(express.urlencoded({ extended: true })); app.get("/health", (req, res) => { res.json({ status: "healthy", service: "LUMA Twilio WhatsApp", timestamp: new Date().toISOString(), port: PORT }); }); app.get("/", (req, res) => { res.send("🔥 LUMA TWILIO WHATSAPP - OPÉRATIONNEL !"); }); app.post("/webhook/twilio-whatsapp", async (req, res) => { try { const { Body, From, To } = req.body; console.log(`📱 Message reçu de ${From}: ${Body}`); const aiResponse = await generateAIResponse(Body); await client.messages.create({ body: aiResponse, from: `whatsapp:${process.env.WHATSAPP_NUMBER}`, to: `whatsapp:${From}` }); console.log(`✅ Réponse envoyée: ${aiResponse}`); await logToNotion(From, Body, aiResponse); res.status(200).send("OK"); } catch (error) { console.error("❌ Erreur:", error); res.status(500).send("Erreur"); } }); async function generateAIResponse(message) { try { const response = await axios.post("https://openrouter.ai/api/v1/chat/completions", { model: "anthropic/claude-3.5-sonnet", messages: [{ role: "system", content: "Tu es LUMA, un assistant IA professionnel et bienveillant. Réponds de manière claire, utile et en français." }, { role: "user", content: message }] }, { headers: { "Authorization": `Bearer ${OPENROUTER_API_KEY}`, "Content-Type": "application/json" } }); return response.data.choices[0].message.content; } catch (error) { console.error("❌ Erreur IA:", error); return "Désolé, je ne peux pas répondre pour le moment."; } } async function logToNotion(from, message, response) { try { await notion.pages.create({ parent: { database_id: process.env.WHATSAPP_HUB_DB }, properties: { "From": { title: [{ text: { content: from } }] }, "Message": { rich_text: [{ text: { content: message } }] }, "Response": { rich_text: [{ text: { content: response } }] }, "Date": { date: { start: new Date().toISOString() } } } }); console.log("✅ Loggé dans Notion"); } catch (error) { console.error("❌ Erreur Notion:", error); } } app.listen(PORT, "0.0.0.0", () => { console.log("🚀 LUMA Twilio WhatsApp Server démarré"); console.log(`🌐 Port: ${PORT}`); console.log("✅ Health check: /health"); console.log("�� Webhook: /webhook/twilio-whatsapp"); console.log("🔗 Prêt à recevoir des messages WhatsApp !"); });
